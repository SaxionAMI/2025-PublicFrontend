import{b as H}from"./QCard.57ffed8c.js";import{Q as Y}from"./QPullToRefresh.b0a0c8b2.js";import{_ as $,D as Q,r as n,u as W,a as J,c as N,f as j,o as z,F as i,G as K,H as X,I as M,J as r,af as E}from"./index.a71a8587.js";import{u as Z}from"./dataStore.7b3c97bb.js";import{G as x,a as ee,S as te}from"./GraphDialog.4302fd0f.js";import{D as ae,U as oe,G as se,a as ne}from"./GraphTypeTabs.4d16972c.js";import{u as le}from"./use-quasar.7fbd2c44.js";import"./format.2831500d.js";import"./use-timeout.9bf131b4.js";import"./QCardSection.b34310d4.js";import"./QDialog.c5fc6a54.js";import"./use-form.4687d2a8.js";const re=Q({name:"GraphPage",components:{GraphItem:x,DateTabs:ae,UnitTypeTabs:oe,GraphTypeTabs:se,DateControls:ne,GraphDialog:ee,StatisticsCards:te},setup(){const e=le(),o=n(!1),f=n(null),S=W(),p=J(),c=Z(),m=n(new Date(new Date().setHours(23,59,59,999))),g=n(!1),v=n(!1),y=()=>{v.value=!0},a=N({get(){return p.pref_sort},set(t){m.value=new Date(new Date().setHours(23,59,59,999)),p.pref_sort=t,d()}}),l=N({get(){return p.pref_unit},set(t){p.pref_unit=t,d()}}),u=n(null),s=()=>{u.value&&clearTimeout(u.value),u.value=setTimeout(()=>{d(),u.value=null},333)},B=()=>({"tagRestrictions.ctypec":["consumption","generation"],dropColumns:["GNAME","ESTYPE","EONNAME"],createEmpty:!0,field:l.value==="kwh"?"ENE":"CO2",windowUnit:a.value,"tagRestrictions.etype":l.value!=="co2"?["powermeter","solarpannel","solarpanel"]:[]}),L=()=>({"tagRestrictions.ctypec":["consumption","generation"],dropColumns:["GNAME","ESTYPE","EONNAME"],createEmpty:!0,field:l.value==="kwh"?"forecast.ENE":"forecast.CO2",windowUnit:a.value}),P=()=>({"tagRestrictions.ctypec":["consumption","generation"],dropColumns:["GNAME","ESTYPE","EONNAME"],createEmpty:!0,field:l.value==="kwh"?"ENE":"CO2",windowUnit:a.value==="H"?"m":a.value==="D"?"H":a.value==="M"?"D":a.value,"tagRestrictions.etype":l.value!=="co2"?["powermeter","solarpannel","solarpanel"]:[]}),R=()=>({"tagRestrictions.ctypec":["consumption","generation"],dropColumns:["GNAME","ESTYPE","EONNAME"],createEmpty:!0,field:l.value==="kwh"?"forecast.ENE":"forecast.CO2",windowUnit:a.value==="H"?"m":a.value==="D"?"H":a.value==="M"?"D":a.value}),I=()=>({"tagRestrictions.ctypec":["supply"],dropColumns:["GNAME","ESTYPE","EONNAME"],createEmpty:!0,field:l.value==="kwh"?"ENE_IMP":"CO2_IMP",windowUnit:a.value}),O=t=>{f.value&&f.value.changeStatusChart(t)},b=n(null),V=n(null),D=n(null),T=n(null),G=n(null),_=N(()=>o.value?c.combineWithForecast(D.value,T.value):c.combineWithForecast(b.value,V.value)),h=async(t,k)=>{const q={endTime:m.value};let A=await c.getData(t,a.value,q);return k.value=A,A},d=async()=>{let t=[];g.value=!0,t.push(h(P(),D)),t.push(h(B(),b)),t.push(h(R(),T)),t.push(h(L(),V)),t.push(h(I(),G)),Promise.all(t).finally(()=>{g.value=!1})},F=t=>{d(),t()};let U=null;const C=()=>{e.loading.show(),d().finally(()=>{e.loading.hide()})};function w(){document.visibilityState==="visible"&&document.hasFocus()&&C()}return j(()=>{C(),U=setInterval(C,5*60*1e3),document.addEventListener("visibilitychange",w),window.addEventListener("focus",w)}),z(()=>{clearInterval(U),document.removeEventListener("visibilitychange",w),window.removeEventListener("focus",w)}),{dataStore:c,childRef:f,updateChart:O,tab:a,refresh:F,unit:l,loading:g,toggle:o,endTime:m,dataBar:b,dataStatisticsImport:G,dataLine:D,authStore:S,showDialog:y,getAllData:d,graphData:_,updateData:s,showGraphDialog:v}}}),ie={id:"controls"},ue={class:"row q-ma-sm"},de={class:"col-6"},pe={class:"col-6"};function ce(e,o,f,S,p,c){const m=i("statistics-cards"),g=i("date-tabs"),v=i("date-controls"),y=i("graph-item"),a=i("unit-type-tabs"),l=i("graph-type-tabs"),u=i("graph-dialog");return K(),X(Y,{onRefresh:e.refresh,color:"accent"},{default:M(()=>[r(H,{class:"q-px-md",style:{display:"flex","flex-flow":"column",height:"100% !important"}},{default:M(()=>[E("div",ie,[r(m,{id:"statistics-cards",data:e.dataStore.combineArrays(e.dataBar,e.dataStatisticsImport),loading:e.loading,tab:e.tab,showAverage:!1,showString:!0,onUpdateChart:e.updateChart,class:"q-my-sm"},null,8,["data","loading","tab","onUpdateChart"]),r(g,{id:"date-tabs",class:"q-mt-md",modelValue:e.tab,"onUpdate:modelValue":o[0]||(o[0]=s=>e.tab=s)},null,8,["modelValue"]),r(v,{class:"q-my-sm",style:{width:"100%"},id:"date-controls",modelValue:e.endTime,"onUpdate:modelValue":[o[1]||(o[1]=s=>e.endTime=s),e.updateData],tab:e.tab},null,8,["modelValue","tab","onUpdate:modelValue"])]),r(y,{id:"graph",data:e.graphData,style:{"flex-grow":"1","min-height":"35vh"},class:"q-pb-sm",isLineChart:e.toggle,showFullscreen:!0,loading:e.loading,excludeDataset:["supply"],tab:e.tab,showLegend:!0,onShowDialog:e.showDialog,ref:"childRef"},null,8,["data","isLineChart","loading","tab","onShowDialog"]),E("div",ue,[E("div",de,[r(a,{modelValue:e.unit,"onUpdate:modelValue":o[2]||(o[2]=s=>e.unit=s)},null,8,["modelValue"])]),E("div",pe,[r(l,{class:"float-right",modelValue:e.toggle,"onUpdate:modelValue":o[3]||(o[3]=s=>e.toggle=s)},null,8,["modelValue"])])]),r(u,{id:"graph-dialog",modelValue:e.showGraphDialog,"onUpdate:modelValue":o[4]||(o[4]=s=>e.showGraphDialog=s),isLineChart:e.toggle,data:e.graphData,showLegend:!0,tab:e.tab},null,8,["modelValue","isLineChart","data","tab"])]),_:1})]),_:1},8,["onRefresh"])}var Se=$(re,[["render",ce]]);export{Se as default};
